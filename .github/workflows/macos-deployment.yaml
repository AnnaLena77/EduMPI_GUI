name: macOS Deployment

env:
  QT_VERSION: 6.8.1
  APP_NAME: appGUI_Cluster

on:
  push:
    branches:
      - 'native'

jobs:
  deploy:
    runs-on: macos-14
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: 'mac'
          target: 'desktop'
          arch: 'clang_64'
          modules: 'qtquick3d qtshadertools'
          tools: 'tools_cmake'
          cache: true

      - name: Install libpq (Homebrew)
        run: |
          brew update
          brew install libpq
          brew link --force libpq

      - name: Configure CMake
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Compile
        run: |
          cmake --build build --config Release -j 3

      - name: Install to staging (optional)
        run: |
          cmake --install build --prefix build/stage

      - name: Bundle app with macdeployqt
        shell: bash
        run: |
          set -euxo pipefail

          APP_PATH=""
          if [ -d "build/Release/${{ env.APP_NAME }}.app" ]; then
            APP_PATH="build/Release/${{ env.APP_NAME }}.app"
          elif [ -d "build/${{ env.APP_NAME }}.app" ]; then
            APP_PATH="build/${{ env.APP_NAME }}.app"
          elif [ -d "build/stage/${{ env.APP_NAME }}.app" ]; then
            APP_PATH="build/stage/${{ env.APP_NAME }}.app"
          else
            echo "ERROR: Could not find ${{ env.APP_NAME }}.app"
            find build -maxdepth 5 -name "*.app" -print
            exit 1
          fi

          if [ -n "${QT_ROOT_DIR:-}" ] && [ -x "${QT_ROOT_DIR}/bin/macdeployqt" ]; then
            MACDEPLOYQT="${QT_ROOT_DIR}/bin/macdeployqt"
          else
            MACDEPLOYQT="$(command -v macdeployqt || true)"
          fi

          if [ -z "$MACDEPLOYQT" ]; then
            echo "ERROR: macdeployqt not found."
            exit 1
          fi

          "$MACDEPLOYQT" "$APP_PATH" \
            -qmldir="${{ github.workspace }}" \
            -always-overwrite \
            -verbose=2

          mkdir -p dist
          cp -R "$APP_PATH" dist/

      - name: Bundle libpq into .app (QPSQL fix)
        shell: bash
        run: |
          set -euxo pipefail

          APP="dist/${{ env.APP_NAME }}.app"
          FW="$APP/Contents/Frameworks"
          PLUGIN="$APP/Contents/PlugIns/sqldrivers/libqsqlpsql.dylib"

          mkdir -p "$FW"

          # Homebrew prefix (Apple Silicon vs Intel)
          if [ -d "/opt/homebrew" ]; then
            BREW_PREFIX="/opt/homebrew"
          else
            BREW_PREFIX="/usr/local"
          fi

          LIBPQ="$BREW_PREFIX/opt/libpq/lib/libpq.5.dylib"
          if [ ! -f "$LIBPQ" ]; then
            echo "ERROR: libpq.5.dylib not found at $LIBPQ"
            exit 1
          fi

          cp -v "$LIBPQ" "$FW/"

          # Patch plugin to use bundled libpq
          install_name_tool -change \
            "/Applications/Postgres.app/Contents/Versions/14/lib/libpq.5.dylib" \
            "@rpath/libpq.5.dylib" \
            "$PLUGIN" || true

          install_name_tool -change \
            "$LIBPQ" \
            "@rpath/libpq.5.dylib" \
            "$PLUGIN" || true

          echo "Final linkage:"
          otool -L "$PLUGIN" | grep -i libpq

      - name: Create DMG
        shell: bash
        run: |
          set -euxo pipefail
          DMG_NAME="${{ env.APP_NAME }}-macOS.dmg"
          hdiutil create -volname "${{ env.APP_NAME }}" \
            -srcfolder "dist/${{ env.APP_NAME }}.app" \
            -ov -format UDZO "dist/${DMG_NAME}"

      - name: Upload .app artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-macOS-app
          path: dist/${{ env.APP_NAME }}.app

      - name: Upload .dmg artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-macOS-dmg
          path: dist/${{ env.APP_NAME }}-macOS.dmg

