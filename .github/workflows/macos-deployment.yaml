name: macOS Deployment

env:
  QT_VERSION: 6.8.1
  APP_NAME: appGUI_Cluster
  BUILD_DIR: build
  INSTALL_DIR: appdir

on:
  push:
    branches:
      - native

jobs:
  deploy:
    runs-on: macos-14

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: mac
          target: desktop
          arch: clang_64
          modules: qtquick3d qtshadertools
          tools: tools_cmake
          cache: true

      # Wichtig:
      # - F체r PostgreSQL runtime brauchst du i.d.R. libpq (+ deps), NICHT postgresql@16.
      # - dylibbundler kopiert externe dylibs (libpq + Abh채ngigkeiten) in die .app und fixt install names.
      - name: Install build dependencies
        run: |
          brew update
          brew install ninja cmake libpq dylibbundler
          echo "$(brew --prefix libpq)/bin" >> $GITHUB_PATH
          echo "PostgreSQL_ROOT=$(brew --prefix libpq)" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix libpq)/lib/pkgconfig" >> $GITHUB_ENV

      - name: Configure (CMake)
        run: |
          cmake -S . -B "${BUILD_DIR}" -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DPostgreSQL_ROOT="${PostgreSQL_ROOT}" \
            -DPostgreSQL_INCLUDE_DIR="${PostgreSQL_ROOT}/include" \
            -DPostgreSQL_LIBRARY="${PostgreSQL_ROOT}/lib/libpq.dylib"

      - name: Build
        run: |
          cmake --build "${BUILD_DIR}" --config Release

      # Optional aber empfohlen (sauberer App-Bundle Output, falls install() vorhanden)
      - name: Install into staging dir (optional, recommended)
        run: |
          cmake --install "${BUILD_DIR}" --prefix "${INSTALL_DIR}"

      - name: Locate .app
        id: locate
        run: |
          set -e
          if [ -d "${INSTALL_DIR}/${APP_NAME}.app" ]; then
            echo "APP_PATH=${INSTALL_DIR}/${APP_NAME}.app" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [ -d "${BUILD_DIR}/${APP_NAME}.app" ]; then
            echo "APP_PATH=${BUILD_DIR}/${APP_NAME}.app" >> $GITHUB_OUTPUT
            exit 0
          fi
          FOUND=$(find . -maxdepth 4 -name "${APP_NAME}.app" -type d | head -n 1)
          if [ -n "$FOUND" ]; then
            echo "APP_PATH=$FOUND" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "Could not find ${APP_NAME}.app"; exit 1

      - name: macdeployqt (bundle Qt frameworks/plugins)
        run: |
          set -e
          APP="${{ steps.locate.outputs.APP_PATH }}"
          echo "Using app: $APP"
          macdeployqt "$APP" -qmldir=. -verbose=2

      # QPSQL Plugin sicherstellen
      - name: Ensure QPSQL driver is bundled
        run: |
          set -e
          APP="${{ steps.locate.outputs.APP_PATH }}"
          PLUGDIR="$APP/Contents/PlugIns/sqldrivers"
          mkdir -p "$PLUGDIR"

          # Schon drin?
          if ls "$PLUGDIR"/libqsqlpsql.dylib >/dev/null 2>&1; then
            echo "QPSQL driver already bundled."
            ls -la "$PLUGDIR"
            exit 0
          fi

          echo "QPSQL not found in app bundle; locating in Qt installation..."

          # 1) 체ber qtpaths6 (am robustesten)
          QTPLUGDIR=""
          if command -v qtpaths6 >/dev/null 2>&1; then
            QTPLUGDIR="$(qtpaths6 --plugin-dir 2>/dev/null || true)"
          elif command -v qtpaths >/dev/null 2>&1; then
            # fallback, falls qtpaths (ohne 6) vorhanden ist
            QTPLUGDIR="$(qtpaths --plugin-dir 2>/dev/null || true)"
          fi

          QSQLPSQL=""
          if [ -n "$QTPLUGDIR" ] && [ -f "$QTPLUGDIR/sqldrivers/libqsqlpsql.dylib" ]; then
            QSQLPSQL="$QTPLUGDIR/sqldrivers/libqsqlpsql.dylib"
          fi

          # 2) fallback: find in typischen Action-Env-Variablen
          if [ -z "$QSQLPSQL" ]; then
            QSQLPSQL=$(find "${Qt6_DIR:-}" "${Qt_DIR:-}" "$HOME" \
              -path "*plugins/sqldrivers/libqsqlpsql.dylib" 2>/dev/null | head -n 1 || true)
          fi

          if [ -z "$QSQLPSQL" ] || [ ! -f "$QSQLPSQL" ]; then
            echo "Could not locate libqsqlpsql.dylib. Ensure QtSql + PostgreSQL driver are present in your Qt install."
            exit 1
          fi

          echo "Found QPSQL: $QSQLPSQL"
          cp "$QSQLPSQL" "$PLUGDIR/"

          echo "Bundled sqldrivers:"
          ls -la "$PLUGDIR"

      # Kritisch: libpq (+ dependencies) in den Bundle kopieren + Install Names fixen.
      # Das behebt typische Crash/No-Connection Probleme, weil das QPSQL Plugin sonst auf /opt/homebrew/... zeigt.
      - name: Bundle libpq + dependencies into .app (fix install names/rpaths)
        run: |
          set -e
          APP="${{ steps.locate.outputs.APP_PATH }}"
          EXE="$APP/Contents/MacOS/${APP_NAME}"
          PLUGIN="$APP/Contents/PlugIns/sqldrivers/libqsqlpsql.dylib"

          if [ ! -f "$EXE" ]; then
            echo "Executable not found at $EXE."
            echo "Contents/MacOS is:"
            ls -la "$APP/Contents/MacOS" || true
            exit 1
          fi
          if [ ! -f "$PLUGIN" ]; then
            echo "QPSQL plugin not found at $PLUGIN."
            ls -la "$APP/Contents/PlugIns/sqldrivers" || true
            exit 1
          fi

          echo "Before (otool -L plugin):"
          otool -L "$PLUGIN" || true

          mkdir -p "$APP/Contents/Frameworks"

          # -od: overwrite destination files if exist
          # -b : bundle dependencies
          # -x : executable / binary to scan & rewrite (works for plugins too)
          # -d : destination to copy dylibs into
          # -p : install-name prefix inside bundle
          dylibbundler -od -b \
            -x "$EXE" \
            -x "$PLUGIN" \
            -d "$APP/Contents/Frameworks" \
            -p "@executable_path/../Frameworks"

          echo "After (otool -L plugin):"
          otool -L "$PLUGIN" || true

          echo "Bundled third-party dylibs (Contents/Frameworks):"
          ls -la "$APP/Contents/Frameworks"

      # Sanity: zeige Linkage des Plugins (entscheidend f체r DB)
      - name: Check QPSQL plugin linkage (sanity)
        run: |
          set -e
          APP="${{ steps.locate.outputs.APP_PATH }}"
          PLUGIN="$APP/Contents/PlugIns/sqldrivers/libqsqlpsql.dylib"
          echo "otool -L $PLUGIN"
          otool -L "$PLUGIN" || true

      # DMG erzeugen (nachdem alles im Bundle ist)
      - name: Create DMG
        run: |
          set -e
          APP="${{ steps.locate.outputs.APP_PATH }}"
          OUTDIR=dist
          mkdir -p "$OUTDIR"

          # DMG via macdeployqt (Qt-Standardweg)
          macdeployqt "$APP" -dmg -verbose=2

          DMG=$(dirname "$APP")/${APP_NAME}.dmg
          if [ ! -f "$DMG" ]; then
            DMG=$(find . -maxdepth 5 -name "${APP_NAME}.dmg" | head -n 1 || true)
          fi
          if [ -z "$DMG" ] || [ ! -f "$DMG" ]; then
            echo "DMG not found"; exit 1
          fi

          mv "$DMG" "$OUTDIR/"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-macos
          path: dist/${{ env.APP_NAME }}.dmg



